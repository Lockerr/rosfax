/// <reference path="../../../lib/jquery-1.2.6.js" />
/*
	Masked Input plugin for jQuery
	Copyright (c) 2007-2009 Josh Bush (digitalbush.com)
	Licensed under the MIT license (http://digitalbush.com/projects/masked-input-plugin/#license) 
	Version: 1.2.2 (03/09/2009 22:39:06)
*/
(function(e){var t=(e.browser.msie?"paste":"input")+".mask";var n=window.orientation!=undefined;e.mask={definitions:{9:"[0-9]",a:"[A-Za-z]","*":"[A-Za-z0-9]"}};e.fn.extend({caret:function(e,t){if(this.length==0)return;if(typeof e=="number"){t=typeof t=="number"?t:e;return this.each(function(){if(this.setSelectionRange){this.focus();this.setSelectionRange(e,t)}else if(this.createTextRange){var n=this.createTextRange();n.collapse(true);n.moveEnd("character",t);n.moveStart("character",e);n.select()}})}else{if(this[0].setSelectionRange){e=this[0].selectionStart;t=this[0].selectionEnd}else if(document.selection&&document.selection.createRange){var n=document.selection.createRange();e=0-n.duplicate().moveStart("character",-1e5);t=e+n.text.length}return{begin:e,end:t}}},unmask:function(){return this.trigger("unmask")},mask:function(r,i){if(!r&&this.length>0){var s=e(this[0]);var o=s.data("tests");return e.map(s.data("buffer"),function(e,t){return o[t]?e:null}).join("")}i=e.extend({placeholder:"_",completed:null},i);var u=e.mask.definitions;var o=[];var a=r.length;var f=null;var l=r.length;e.each(r.split(""),function(e,t){if(t=="?"){l--;a=e}else if(u[t]){o.push(new RegExp(u[t]));if(f==null)f=o.length-1}else{o.push(null)}});return this.each(function(){function d(e){while(++e<=l&&!o[e]);return e}function v(e){while(!o[e]&&--e>=0);for(var t=e;t<l;t++){if(o[t]){c[t]=i.placeholder;var n=d(t);if(n<l&&o[t].test(c[n])){c[t]=c[n]}else break}}w();s.caret(Math.max(f,e))}function m(e){for(var t=e,n=i.placeholder;t<l;t++){if(o[t]){var r=d(t);var s=c[t];c[t]=n;if(r<l&&o[r].test(s))n=s;else break}}}function g(t){var r=e(this).caret();var i=t.keyCode;h=i<16||i>16&&i<32||i>32&&i<41;if(r.begin-r.end!=0&&(!h||i==8||i==46))b(r.begin,r.end);if(i==8||i==46||n&&i==127){v(r.begin+(i==46?0:-1));return false}else if(i==27){s.val(p);s.caret(0,E());return false}}function y(t){if(h){h=false;return t.keyCode==8?false:null}t=t||window.event;var n=t.charCode||t.keyCode||t.which;var r=e(this).caret();if(t.ctrlKey||t.altKey||t.metaKey){return true}else if(n>=32&&n<=125||n>186){var u=d(r.begin-1);if(u<l){if(i.upcase){var a=String.fromCharCode(n).toUpperCase()}else{var a=String.fromCharCode(n)}if(o[u].test(a)){m(u);c[u]=a;w();var f=d(u);e(this).caret(f);if(i.completed&&f==l)i.completed.call(s)}}}return false}function b(e,t){for(var n=e;n<t&&n<l;n++){if(o[n])c[n]=i.placeholder}}function w(){return s.val(c.join("")).val()}function E(e){var t=s.val();var n=-1;for(var r=0,u=0;r<l;r++){if(o[r]){c[r]=i.placeholder;while(u++<t.length){var h=t.charAt(u-1);if(o[r].test(h)){c[r]=h;n=r;break}}if(u>t.length)break}else if(c[r]==t[u]&&r!=a){u++;n=r}}if(!e&&n+1<a){s.val("");b(0,l)}else if(e||n+1>=a){w();if(!e)s.val(s.val().substring(0,n+1))}return a?r:f}var s=e(this);var c=e.map(r.split(""),function(e,t){if(e!="?")return u[e]?i.placeholder:e});var h=false;var p=s.val();s.data("buffer",c).data("tests",o);if(!s.attr("readonly"))s.one("unmask",function(){s.unbind(".mask").removeData("buffer").removeData("tests")}).bind("focus.mask",function(){p=s.val();var e=E();w();setTimeout(function(){if(e==r.length)s.caret(0,e);else s.caret(e)},0)}).bind("blur.mask",function(){E();if(s.val()!=p)s.change()}).bind("keydown.mask",g).bind("keypress.mask",y).bind(t,function(){setTimeout(function(){s.caret(E(true))},0)});E()})}})})(jQuery)